---
title: "Test_Report1"
author: "Kaveh G. Siah"
date: "10/27/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
options(tinytex.verbose = TRUE)
```

```{r, include=FALSE}
library(kableExtra)

```

# Nutrient Cycling in Forest Ecosystems

## (NutsFor)

Programmer:

Manual Author: 

## User Manual for Version ()

<!--Title Page Below, possible background theme/image-->

<!--Insert table of contents (headers automatically added to it)-->

<!--Insert List of Abbreviations-->

### Introduction

<!--Meant to be a User guide, maybe a breif history can be mentioned at the end, but the intro should be short and descriptive-->

The Nutrient Cycling in Forested Ecosystems (NutsFor) model is
a stand-level biogeochemical model which simulates the forest nutrient dynamics of 16 chemical species <!--List species-->
These processes include hydrology, soil exchange site chemistry, mineral
weathering, stand growth and uptake, and atmospheric deposition. This manual describes the most recent iteration of NutsFor (version ……), which further includes stand harvest, biomass residues, separate pools of soil water, and other small
changes made to the original model described in van der Heijden et al, 2017. All
changes from the original model are noted with an asterisk (“*”). As NutsFor is
an active project of Gregory van der Heijden, model capabilities are open to change based on collaboration. 

This user manual is intended to give relevant information about the model's capabilities, useful tips regarding its usage, and insight into the equations and theory which link model parameters. A list of equations used to parameterize NutsFor are also included, along with some description of how these equations are used. 



### Model Start Up

Prior to running or implementing change to model parameters, the user should go through the input and output files for NutsFor using excel. NutsFor does not currently have a built-in method to visualize results, it is recommended that the user use excel macro commands or R to automatically read generated files (which will always output with the same structure) to visualize results. This is highly important in the calibration phase of model implementation.

The model is simple to run, simply double-click or other wise enact the NutsFor.exe file. The model will run and output results
to its corresponding .csv files automatically. If the output files are moved from the NutsFor directory or removed, NutsFor will generate new csv files as long as
the Output folder is still present in the NutsFor.exe directory. A successful model run will be accommodated by a “Exporting Model Run Data” and “Model Run End-Press Return to Close”. Unsuccessful model runs (i.e., crashes) will result in either the NutsFor exe closing on its own or on the former messages never appear in the NutsFor.exe box.



Input Files

There are 10 input files for NutsFor (the .nut files). These
files are csv files which can be opened through excel. A full list of the input
parameters, separated by the file they appear in, is shown in the tables below.
Below each table is a more extensive description of each variable and its
effects on model outputs.



Dry Deposition

![InputTable1](C:\Users\siahl\Documents\Manual Figures\InputTable1.png)

Description of Parameters: Dry Deposition

The dry deposition file is comparable to the Rain Concentration file. It simply delegates the deposition of chemical species without the deposition of water. The file starts with An and Mois (Year and Month Columns), and then lists out chemical species from left to right. 

<!--Insert units as an image, its way easier-->

```{r, include=FALSE}
text_tbl <- data.frame(
Input= c("Ca, Mg, Cl, Al...etc,"),
Description = c("Determines the amount of each species deposited into ecosystem by Dry Deposition")
)



```



```{r, include=TRUE}
kbl(text_tbl, booktabs = T, col.names =  c("Input ($\\mu$mol/L)", "Description")) %>%
kable_styling(full_width = F) %>%
column_spec(1, bold = T) %>%
column_spec(2, width = "20em")
 
```

 
 Soil Parameters

<!--Table 2 Here-->

Description of Parameters: Soil Parameters

<!--Keep concise but informative-->

***Soil Layers:***

NutsFor allows any number of soil layers to be set in the
model. Extra layers are added by typing in the new layer quantity into the
Soil_Layer parameter, and adding the new layer to the Soil Parameter file by
parameterizing the new layer as is done for layers before it. When a new layer
is added, the spacing between the different tables in the soil parameters file
is offset, the tables must be cut and pasted such that a single row of blank
cells lies between the tables, otherwise NutsFor will not be able to read the
tables. The total number of soil layers (Nb_Layers) must also be updated in the
General Data File before running the model.

***Depth and Thickness:***

The depth of the soil layer represents the vertical distance
of the soil layer from the surface of the soil, it is not used in any
calculations. Soil layer thickness determines how thick each soil layer is, it
is recommended that soil layers are set to less than or equal to 20cm thick. Overly thick
soil layers may be liable to over-leaching of nutrients from the soil layers.

***Bulk Density, Solid Density, and Stoniness:***

Bulk density is defined as fine earth bulk density
(particles less than 2mm in diameter). Solid density is not part of the
calculations of NutsFor, and can be ignored. Stoniness is the percent of soil
particles greater than 2mm in diameter, this parameter affects soil moisture
and hydrology calculations and is important to calculate.

***Root Fraction and Uptake Fraction per Layer:***

Keeps trace of the root distribution of the stand between
the soil layers, however it does not determine the uptake of nutrients per
layer. The Uptake Fraction per layer parameter truly determines how the stand
extracts nutrients from the soil layers, allowing for greater flexibility in
determining tree uptake dynamics. Intra-annual uptake dynamics are changed
through the Tree Parameter file.

**pKGibb, pKAl_Precip, pCO2:**

The pKGibb parameter is the -log of the reaction constant of
gibbsite dissolution to free aluminum, similarly the pKAl_precip is the -log of
the reaction constant of Al and its precipitated forms (i.e., the solubility
product). The range of pKAl_precip (or Ksp of Al(OH)3(s)) should be in the
range of 32-35 depending on the pH of the soil layer, pKGibb ranges from 6-9. These
aluminum parameters are important in determining pore water pH, as Al is the
largest contributor of H+ compared to other acids in the model. pCO2 is the
partial pressure of carbon dioxide in the soil solution, it is a constant
multiple of atmospheric CO2 and is <u>not dynamic with decomposition rates.</u>

**Mineral Area**

This parameter designates the total weatherable mineral surface area of the soil. It is calculated from the equation:

General Equation 1:

$$
(8*X.Clay)+(2.2*X.Silt)+(0.03*X.Sand)
$$

Citation: 

Note, that clays dominant in high area clays may be misrepresented by this equation *(Citation)*

A more detailed equation, which takes into consideration different sand and silt size particles;

General Equation 2:
$$
()+()+()
$$
Citation:

The mineral area parameter is historically difficult to obtain empirically, clay mineralogy plays a large role in determining this parameter, and is seldom measured to its full capacity (SOURCE). The fraction of soil particles in each size class (X.Clay, X.Silt, and X.Sand) are to be calculated from the <u>whole soil</u> (including coarse fragment count), not just the fine particulate fraction. Since this parameter is difficult to calculate, it will be likely that simulated mineral weathering rates are lower than those observed or calculated for a given stand. In this case the mineral weathering rates must be calibrated by increasing (or decreasing, if weathering is too high) the mineral area parameter. Mineral weathering rates are linked to proton concentrations, lower pH stimulates mineral weathering. Mineral weathering thus consumes protons and can be included in the calibration of pH and alkalinity. Thus, another way of calibrating mineral weathering rates can be the calibration of proton concentrations. 

Soil Moisture Parameters

1. Wilting Point

   The percent soil moisture which corresponds to the wilting point; i.e., the pressure of water in the soil matrix is at -15kPa. Wilting point may have a different reference pressure depending on the texture of the soil. 

2. Field Capacity

   The percent soil moisture which corresponds to how much water the soil can hold after drainage of excess water. Typically this measurement is set to the reference pressure of -33kPa. 

3. Saturation

   The percent of soil moisture corresponding to all pore space in soil being filled with water. It can be set as the effective porosity of the soil. 

CEC Parameters and CEC Initial

1. CEC

   This parameter is the effective cation exchange capacity (ECEC) of each soil layer. This parameter is usually measured for every soil and soil layer for every depth increment, however there are multiple methods through which this can be accomplished (Citation, General technical manual). In general, ECEC can be calculated as:

   General Equation #X.1
   $$
   ECEC= 2[Ca^{+2}]+ 2[Mg^{+2}]+[K^+]+[Na^+]+3[Al^{+3}]+[NH_{4}^{+}]
   $$

2. Gapon Selectivity Coefficients (KH_Cation)

   These coefficients determine the propensity of each cation to be replaced on the CEC with H+.  High selectivity coefficients indicate that a cation has a high affinity for the CEC, and are thus liable to stay on the CEC rather than weather off due to the presence of other cations. Low coefficients will likely lead to high CEC weathering of cations, which may result in high soil solution pH. This is due to both the consumption of protons in the soil solution, which kick off low-affinity cations, as well as the increase in acid neutralizing capacity (ANC) that comes with increased base cation concentrations. This is because ANC is calculated as the sum of base cations minus the sum of acid anions. When ANC is near or above 0, soil solution pH will be difficult to constrain. 

   Gapon coefficients are to be calculated as:

   General Equation #X.2
   $$
   K_{H:Cation^{+n}}= (E_{Cation^{+n}}/[Cation^{+n}])*([H^{+}]/E_{H})^{n}
   $$
   Where;
   $$
   E_{H}=[H^{+}]_{adsorbed}/ECEC
   $$
   and 
   $$
   E_{Cation^{+n}}=[Cation^{+n}]_{adsorbed}/ECEC
   $$
   Note that 
   $$
   n = Valence
   $$
   All concentration units are in mmol/L. It should be noted that these values heavily rely on measured initial cation concentrations, and so they may be manipulated to get a better match between adsorbed and dissolved cations. Note that increasing the selectivity coefficient of one cation will change the relative selectivity of all cations. For instance, increasing Ca selectivity will lead to more Ca adsorption to the CEC, which will in turn kick off other cations, assuming the selectivity of the other cations remains the same. 

3. CEC Initial 

   This parameter is not under the "CEC parameters" heading in the Soil Parameter file, rather it is located at the bottom of the Soil Parameter File (it it the last table, named CEC Initial). This parameter determines the total adsorbed supply of cations initially on the cation exchange complex. 

   

   ### AEC Parameters

   Anion Exchange Capacity (AEC) is implemented in the model for 3 anions; Sulfate, Phosphate, and Chloride. Sulfate adsorption can be modeled using either  a Langmuir or Freundlich adsorption isotherm. Chloride is modeled using the Langmuir model, Phosphate the Freundlich model. Sulfate adsoprtion isotherms can be selected in the General Data File (Input Table 4). 

   

   1. Soil Adsorbed Anions Parameters

      Each anion has two AEC adsorption parameters associated with it, Parameter #1 and Parameter #2. These parameters will stand for different variables depending on the adsoprtion isotherm selected. 

      Langmuir

      Freundlich

   2. Soil Adsorbed Anions Initial

   

   

<!--Insert Pictures instead of encoded tables-->

| Input Table<br> 3: OM decomposition                          |
| ------------------------------------------------------------ |
| Parameter Name in File                                       |
| Litter Concentration (N, Ca, Mg, K, S, P)                    |
| Litter_C_Pool                                                |
| Layer_frac (Coarse, Fine, Humus)                             |
| Decomp_rate                                                  |
| CO2FACT                                                      |
| Nutrient_Factor (DOCFACT, N_Fact, Ca_Fact, Mg_Fact, K_Fact, S_Fact,<br> P_Fact). |

Description of Parameters: OM Decomposition

**Litter Parameters**

Litter parameters can be broken up into 3 sections:

1. Litter Concentration (N, Ca, Mg, K, S, P)
2. Litter Pool (Litter_C_Pool, Litter_Fraction)
3. Litter Nutrient Release Dynamics 

I). Litter Concentration

This table sets the concentration of main  nutrient cations in the litter layer relative to the amount of carbon in the litter. 

II). Soil_Layer:

1). The coarse litter fragment of the litter layer (fresh litter included)

2). The fine litter fragment

3). The humus ("Very fine SOM") fraction

Decomp_Rate: The k of decomposition, determining how much carbon decomposes from litter pools.

 Co2_Fact: Determines the fraction of decomposed carbon which is evolved as carbon dioxide 

N_Fact, Ca_Fact, Mg_Fact, K_Fact, S_Fact, P_Fact: Determines release rate of corresponding nutrient relative to C release due to decomposition. These parameters can be tweaked to globally slow the mobilization of nutrients from the litter pool. 

DOCFACT:

This factor determines the fraction of the decomposed C pool at each time step and for each litter pool which is released as DOC. Increasing this factor increases DOC and thus organic acid (R-) concentrations in the simulated soil. This tends to lower pH according to the set pKa of organic acids (See OA_pKa in Input table 4). 

DOC_Decomp:

Determines the proportion of DOC evolved from decomposing litter that is itself decomposed. This parameter decreases OA (R-), however it does not link back to carbon dioxide release as carbon dioxide concentration is a fixed parameter (See, Input table 2, pCO2)



| Input Table 4: General<br> Data File |
| ------------------------------------ |
| Parameter Name in<br> File           |
| Start_year                           |
| End_Year                             |
| Nb_Layers                            |
| Nb_Minerals                          |
| Mineral_names                        |
| OA_pka                               |
| Aluminum                             |
| Phosphoric_acid                      |
| DIC                                  |
| Organic_acid_size                    |
| Nb_Tree_Comp                         |

Description of Parameters: General Data File

| Input Table 5: Mineral Data File                            |
| ----------------------------------------------------------- |
| Parameter Name in File                                      |
| Mineral                                                     |
| pKH, pKH2O, pKCO2, pKr                                      |
| kH, kH20, kCO2,kr                                           |
| nH, nCO, nr                                                 |
| WAlH, WBCH, WAlH2O, WBCH2O                                  |
| CAl*10^-6, CR*10^-6 CBC*10^-6                               |
| Cation Composition of Minerals (Ca, Mg, K, Na, Al, Si, PO4) |
| Iso                                                         |

Description of Parameters: Mineral Data File

| Input Table 6: Tree Parameter File |
| ---------------------------------- |
| Parameter Name in File             |

Description of Parameters: Tree Parameter File

<!--Stand Harvesting File-->

Output File Description

<!--Just the core, relevant data files. Some files just convert between units and shouldn't get an extensive description-->

Calibration

<!--Disclaimer abouut site specific differences-->

<!--Describe general calibration steps, pH, weathering, ANC, ion concentrations-->

Hypothesis Testing

## List of Equations

**NutsFor Encoded Equations**

<!--~~List Gregory's equation table here, with updated sulfate ads.~-->

**General Equations**

## Literature Cited

Appendix, maybe include screenshots of input interface? 